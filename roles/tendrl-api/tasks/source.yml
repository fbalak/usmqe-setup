- name: Install the 'Development tools' package group
  yum:
    name="@Development tools"
    state=present

- name: Install Ruby
  yum:
    name={{ item }}
    state=present
  with_items:
    - ruby
    - ruby-devel
    - rubygem-bundler

- name: Clone tendrl.git
  git:
    repo={{ tendrl_api_repo_url }}
    version={{ tendrl_api_repo_branch }}
    dest={{ tendrl_api_local_path }}

- name: Exclude files created by bundler from repo (HACK)
  command: git update-index --assume-unchanged Gemfile.lock
    chdir={{ tendrl_api_local_path }}

- name: Install Ruby bundler (HACK)
  gem:
    name=bundler

- name: Bundle installation of Tendrl (HACK)
  bundler:
    state=present
    binstub_directory={{ tendrl_api_bundle_install_path }}
    chdir={{ tendrl_api_local_path }}
  when: not tendrl_api_bundle_without

- name: Bundle installation of Tendrl (HACK)
  bundler:
    state=present
    binstub_directory={{ tendrl_api_bundle_install_path }}
    exclude_groups={{ tendrl_api_bundle_without_groups }}
    chdir={{ tendrl_api_local_path }}
  when: tendrl_api_bundle_without

- name: Directory for config
  file:
    path={{ tendrl_api_local_path }}/config/sds
    state=directory

- name: Create config file with connection to etcd
  shell: cp -r {{ tendrl_api_local_path }}/config/etcd.sample.yml {{ tendrl_api_local_path }}/config/etcd.yml

#
## TODO update the apache config file to specific host details


- name: Configure config/etcd.yml - host
  lineinfile:
    dest={{ tendrl_api_local_path }}/config/etcd.yml
    regexp="^  {{ ":" }}host{{ ":" }} \'127.0.0.1\'"
    line="  {{ ":" }}{{ item }}{{ ":" }} \'{{ hostvars[groups['usm_server'][0]]['ansible_eth0']['ipv4']['address'] }}\'"
  with_items:
    - host
    - host
    - host

